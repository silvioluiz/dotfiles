#!/usr/bin/env bash
set -euo pipefail
{{ include "init_macos_env" | indent 0 }}


echo "[+] Instalando mise..."

if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS: via Homebrew (assumido já instalado)
  if ! command -v mise >/dev/null 2>&1; then
    brew install mise
  fi
elif [[ "$OSTYPE" == "linux"* ]]; then
  # Linux (ex.: Ubuntu 24.04): installer oficial
  if ! command -v mise >/dev/null 2>&1; then
    curl -fsSL https://mise.run | sh
    # mise instala em ~/.local/bin por padrão;
    # garante que esteja acessível nesta sessão
    export PATH="$HOME/.local/bin:$PATH"
  fi
fi

# Garante PATHs úteis para os próximos passos
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

echo "[+] Garantindo cargo-binstall no PATH..."
if ! command -v cargo-binstall >/dev/null 2>&1; then
  # Instala cargo-binstall via binário (sem compilar o mundo)
  # Fonte oficial: https://github.com/cargo-bins/cargo-binstall
  curl -fsSL \
    https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh \
    | bash
else
  echo "[✓] cargo-binstall já instalado."
fi

# (Opcional) valida versão e mostra onde está
if command -v cargo-binstall >/dev/null 2>&1; then
  echo "[i] cargo-binstall: $(command -v cargo-binstall)"
  cargo-binstall -V || true
fi

echo "[+] Configurando runtimes e ferramentas globais com mise..."
# --yes para auto-confirmar prompts de instalação (onde suportado)
mise install --yes

echo "[✔] mise pronto (runtimes e CLIs instalados conforme config.toml)."
