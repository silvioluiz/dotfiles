#!/usr/bin/env bash
# run_once_05_zsh_ohmyzsh.sh.tmpl
set -euo pipefail

log() { printf "[zsh-setup] %s\n" "$*"; }
have() { command -v "$1" >/dev/null 2>&1; }

# Executa comando com sudo NÃO interativo; se não for permitido, apenas loga e segue.
sudo_n() {
  if have sudo && sudo -n true 2>/dev/null; then
    sudo -n "$@"
  else
    log "sudo -n indisponível para: $* (sem prompt). Pulando esta etapa."
    return 1
  fi
}

install_ohmyzsh() {
  if [ -d "$HOME/.oh-my-zsh" ]; then
    log "Oh My Zsh já presente em ~/.oh-my-zsh — pulando instalação."
    return 0
  fi
  if ! have curl; then
    log "curl não encontrado — instale curl e rode novamente."
    exit 1
  fi
  # Instala OMZ sem criar .zshrc e sem chsh
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
}

OS="{{ .chezmoi.os }}"

if [ "$OS" = "darwin" ]; then
  # =========================
  # macOS: não instalar zsh, não alterar shell padrão
  # =========================
  log "macOS detectado — NÃO instalar zsh e NÃO alterar shell padrão."
  if have zsh; then
    log "zsh detectado: $(zsh --version) em $(which zsh)"
  else
    log "Aviso: zsh não encontrado no PATH (incomum no macOS). Verifique /bin/zsh."
  fi
  install_ohmyzsh
  log "Concluído no macOS (sem brew install, sem chsh, sem criar .zshrc)."

elif [ "$OS" = "linux" ]; then
  # =========================
  # Linux (Ubuntu): instalar zsh se faltar e mudar shell padrão SEM prompt
  # =========================
  DIST_ID="$(. /etc/os-release 2>/dev/null && echo "${ID:-}")"
  if [ "${DIST_ID}" != "ubuntu" ]; then
    log "Linux detectado (ID='${DIST_ID:-?}'). Seguindo fluxo genérico."
  fi

  if ! have zsh; then
    log "zsh não encontrado — tentando instalar via apt (sem prompt)..."
    if have apt-get; then
      sudo_n apt-get update -y && sudo_n apt-get install -y zsh || log "Não foi possível instalar zsh sem prompt."
    else
      log "apt-get não encontrado. Instale zsh manualmente e rode novamente."
    fi
  fi

  # Determina caminho do zsh (se disponível após a etapa acima)
  ZSH_PATH="$(command -v zsh || true)"
  if [ -n "${ZSH_PATH}" ]; then
    # Garante entrada em /etc/shells (sem prompt)
    if [ -f /etc/shells ] && ! grep -q "^${ZSH_PATH}$" /etc/shells 2>/dev/null; then
      log "Adicionando ${ZSH_PATH} a /etc/shells (sem prompt)..."
      sudo_n /bin/sh -c "echo '${ZSH_PATH}' >> /etc/shells" || true
    fi

    # Muda shell padrão (sem prompt). Se não puder, só loga.
    CURRENT_SHELL="$(getent passwd "$USER" | awk -F: '{print $7}' || true)"
    if [ "${CURRENT_SHELL:-}" != "${ZSH_PATH}" ]; then
      log "Alterando shell padrão para ${ZSH_PATH} (sem prompt)..."
      sudo_n chsh -s "${ZSH_PATH}" "${USER}" || log "Não foi possível alterar shell padrão sem prompt."
    else
      log "Shell padrão já é ${ZSH_PATH}"
    fi
  else
    log "zsh ainda indisponível após tentativa de instalação."
  fi

  install_ohmyzsh
  log "Concluído no Ubuntu (zsh presente se possível, tentativa de chsh sem prompt, sem criar .zshrc)."

else
  log "SO não reconhecido pelo template (.chezmoi.os='$OS'). Sem ações."
fi
